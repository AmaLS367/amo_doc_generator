# Генератор документов для amoCRM

Этот проект добавляет к сделке формирования документов `.docx` на основе шаблонов Word и данных сделки/контакта. Поддерживаются два шаблона: **заказ-наряд** и **акт**. Документы генерируются на сервере и сохраняются в папке `documents/`, после чего ссылка возвращается в интерфейс.

---

## 1) Архитектура

```
amo_doc_generator/
├─ api/
│  ├─ generate.php        # Генерация .docx по данным формы и из amoCRM
│  └─ prefill.php         # Возврат последнего сохраненного состояния формы по lead_id
├─ config/
│  ├─ config.php          # Настройки проекта и OAuth-данные amoCRM
│  └─ token.json          # Акutальные OAuth-токены (автогенерация)
├─ data/
│  └─ cache/              # Кеш для префилла по lead_id (автосоздание)
├─ documents/             # Сохраненные документы .docx (автосоздание)
├─ logs/
│  ├─ generate.log        # Ошибки и исключения
│  └─ debug_generate.log  # Отладочные записи
├─ public/
│  ├─ ui.html             # UI для пользователя
│  ├─ app.js              # Логика формы, отправка на API
│  └─ main.css            # Стили UI
├─ templates/
│  ├─ order_template.docx # Шаблон Заказ-наряда
│  └─ act_template.docx   # Шаблон Акта
├─ oauth.php              # Обмен `code` → токены и запись в config/token.json
├─ composer.json          # Зависимости (phpoffice/phpword)
└─ composer.phar          # Локальный Composer (можно использовать системный)
```

Бэкенд: PHP 7.4+ с `phpoffice/phpword`  
Фронтенд: `public/ui.html` + `public/app.js` (запрашивает API и отрисовывает форму).

---

## 2) Требования к серверу

- PHP **7.4+**.
- Расширения PHP: **zip**, **xml**, **mbstring**, **json**, **curl**.
- Права на запись для каталогов: `documents/`, `logs/`, `data/`, `data/cache/`.
- Composer (можно системный `composer`, либо локальный `php composer.phar`).

Установка зависимостей (из корня проекта):
```bash
composer install
# или
php composer.phar install
```

---

## 3) Настройка под новый домен/размещение

1. **Скопируйте** папку проекта на хостинг. Рекомендуемый URL-базис: `https://<ваш-домен>/<путь>/amo_doc_generator`.
2. Выдайте права на запись для `documents/`, `logs/`, `data/`:
   ```bash
   chmod -R 775 documents logs data
   # при необходимости 777 в окружениях без корректных владельцев веб-процесса
   ```
3. В `public/app.js` **обновите базовый URL API**:
   ```js
   // было:
   const API = 'https://apiport.ru/amo_doc_generator';
   // должно указывать на ваш домен/путь, например:
   const API = 'https://<ваш-домен>/<путь>/amo_doc_generator';
   // или используйте относительный путь, если UI и API на одном хосте:
   // const API = '/amo_doc_generator';
   ```
4. Убедитесь, что по адресу `https://<ваш-домен>/<путь>/amo_doc_generator/public/ui.html` UI открывается без ошибок браузера.

---

## 4) Подключение к новому аккаунту amoCRM (новая интеграция)

> Задача: получить `client_id`, `client_secret`, `redirect_uri` и сохранить OAuth-токены в `config/token.json`.

### 4.1. Создайте **приватную интеграцию** в amoCRM
- В интерфейсе amoCRM создайте новую интеграцию (приватную).
- Укажите **Redirect URI**:  
  `https://<ваш-домен>/<путь>/amo_doc_generator/oauth.php`
- Сохраните выданные **Client ID** и **Client Secret**.

### 4.2. Пропишите настройки в `config/config.php`
```php
return [
  'client_id'     => 'ВАШ_CLIENT_ID',
  'client_secret' => 'ВАШ_CLIENT_SECRET',
  'redirect_uri'  => 'https://<ваш-домен>/<путь>/amo_doc_generator/oauth.php',
  'base_domain'   => 'https://<subdomain>.amocrm.ru', // домен вашего аккаунта
  'subdomain'     => '<subdomain>',

  'template_path' => __DIR__.'/../templates/',
  'document_path' => __DIR__.'/../documents/',
  'temp_data_path'=> __DIR__.'/../data/',

  'prefill_ttl_days' => 5,
];
```

### 4.3. Авторизуйте интеграцию
1. Перейдите по ссылке авторизации из карточки интеграции amoCRM **или** сформируйте URL авторизации по данным интеграции.
2. После успешного согласия вы будете перенаправлены на `oauth.php` с параметром `?code=...`.
3. Скрипт `oauth.php` выполнит обмен `code → access/refresh` и сохранит токены в `config/token.json`.
4. Дальше обновление токенов выполняется **автоматически** внутри `api/generate.php` при получении ответа 401 от amoCRM.

Проверка: после авторизации файл `config/token.json` должен появиться с валидными токенами.

---

## 5) Встраивание в карточку сделки

Минимально достаточно открыть UI со `lead_id`:
```
https://<ваш-домен>/<путь>/amo_doc_generator/public/ui.html?lead_id=<ID_сделки>
```
Способы:
- Кнопка/ссылка в карточке сделки, ведущая на этот URL.
- Встроить через ваш виджет как iframe с тем же URL.

> Параметр `lead_id` обязателен для подстановки данных и работы кеша префилла.

---

## 6) Как пользоваться UI

1. Откройте `ui.html` с параметром `lead_id`.
2. При наличии кеша формы по этой сделке скрипт подтянет его из `api/prefill.php`.
3. Заполните таблицу позиций: **Название**, **Цена за единицу**, **Кол-во**, **Скидка % на строку**.
4. При необходимости укажите **общую скидку** в рублях (поле «Скидка» справа).
5. Выберите **шаблон**: `order` (заказ-наряд) или `act` (акт).
6. Нажмите **«Сформировать»**. В ответ вернется ссылка на `.docx` в `documents/`.

Итоги и суммы считаются на фронтенде и продублированы на бэкенде. Число прописью формируется на обеих сторонах.

---

## 7) API

### `POST /api/generate.php`
Вход (JSON):
```json
{
  "lead_id": 123456,
  "template": "order",          // или "act"
  "discount": 500,              // общая скидка в рублях
  "products": [
    {
      "name": "Диагностика",
      "unit_price": 1500,
      "qty": 1,
      "discount_percent": 0
    }
  ]
}
```
Выход:
```json
{ "url": "https://<домен>/<путь>/amo_doc_generator/documents/<файл>.docx" }
```
Коды ошибок: `400 Bad JSON/Invalid lead_id or products`, `500 Internal Server Error`.

### `GET /api/prefill.php?lead_id=<id>`
Возвращает последнее сохраненное состояние формы для сделки:
```json
{
  "template": "order",
  "discount": 0,
  "products": [ ... ],
  "saved_at": 1710000000
}
```

---

## 8) Данные, подтягиваемые из amoCRM

`generate.php` получает по API amoCRM:
- Сделку `leads/{id}?with=contacts`.
- Связанный контакт (если есть).

Используются значения полей:
- ФИО: приоритет — кастомные поля **«Фамилия»**, **«Имя»**, **«Отчество»** на сделке; иначе берутся из имени контакта.
- Телефон: поле `PHONE` у контакта (если найден).
- Технические поля авто: **«Марка»**, **«Модель»**, **«VIN»**, **«Год выпуска»** — берутся из **кастомных полей** сделки по **точному названию**.

> Если у вас другие названия полей, скорректируйте маппинг в `api/generate.php` (поиском `setValue('Марка'|...)` и функцией `$getCF`).

---

## 9) Шаблоны Word и плейсхолдеры

В `templates/` лежат два файла: `order_template.docx` и `act_template.docx`.  
Используются плейсхолдеры PhpWord `TemplateProcessor`:

**Единичные поля**
```
${Номер}
${Дата}
${Телефон}
${Марка}
${Модель}
${VIN}
${Год выпуска}
${Фамилия}
${Имя}
${Отчество}
${Итого}
${Скидка}
${Всего к оплате}
${Количество наименований}
${Сумма прописью}
```

**Табличные строки** (нумерация `#1`, `#2`, ...):
```
${row_num#1}
${услуга_название#1}
${row_qty#1}
${row_price#1}
${row_discount#1}    // «10%» или «-», если скидки нет
${row_sum#1}
```
При генерации строки клонируются по количеству позиций.

**Изменение шаблонов**
- Редактируйте `.docx` только в MS Word/LibreOffice.
- Не изменяйте ключи плейсхолдеров в коде без синхронизации с файлами.
- Для добавления нового шаблона потребуется доработка кода (сейчас допустимы значения `order` и `act`).

---

## 10) Логи и диагностика

- `logs/generate.log` — ошибки/исключения PHP.
- `logs/debug_generate.log` — диагностические записи (id сделки, найденные поля и т.п.).
- При ошибке 401 по amoCRM токен **обновляется автоматически** через refresh. Если refresh не сработал — проверьте `config/config.php` и заново выполните **раздел 4.3**.

---

## 11) Миграция на другой аккаунт amoCRM / новую интеграцию

Чек-лист:
1. Скопировать проект на целевой хостинг, выдать права на `documents/`, `logs/`, `data/`.
2. Выполнить `composer install`.
3. Создать **новую приватную интеграцию** в целевом аккаунте amoCRM.
4. Обновить `config/config.php` (`client_id`, `client_secret`, `redirect_uri`, `base_domain`, `subdomain`).
5. Открыть ссылку авторизации и пройти **раздел 4.3**, чтобы записался `config/token.json`.
6. Обновить `public/app.js` → константа `API` под новый домен/путь.
7. Проверить открытие UI по `public/ui.html?lead_id=<id>` и генерацию документов.
8. При необходимости адаптировать маппинг кастомных полей (раздел 8).

---

## 12) Безопасность

- Не храните `config/` и `documents/` в общедоступном корне без ограничений листинга. На Apache/Nginx запретите индексирование директорий.
- `config/token.json` — чувствительный файл. Убедитесь, что к нему нет прямого внешнего доступа по URL.
- При публикации репозитория исключайте `config/token.json` из VCS.

---

## 13) Известные ограничения

- Глобальная скидка — **в рублях**, скидка по строкам — **в процентах**.
- Шаблоны фиксированы: `order` и `act`.
- Ожидаются конкретные названия кастомных полей (см. раздел 8).

---

## 14) Быстрый smoke-test после установки

```bash
# 1) Проверка PHP-зависимостей
php -m | grep -E 'zip|xml|mbstring|curl|json'

# 2) Проверка UI
open https://<домен>/<путь>/amo_doc_generator/public/ui.html?lead_id=TEST_ID

# 3) Тест API (пример)
curl -X POST https://<домен>/<путь>/amo_doc_generator/api/generate.php   -H 'Content-Type: application/json'   -d '{"lead_id":123456,"template":"order","discount":0,"products":[{"name":"Тест","unit_price":1000,"qty":1,"discount_percent":0}]}'

# Ожидается {"url":"https://.../documents/<файл>.docx"}
```
